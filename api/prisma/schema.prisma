generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum TipoUsuario {
  PLAYER
  DONO_TIME
  DONO_SOCIETY
}

enum TipoPagamento {
  AVULSO
  MENSALISTA
  CONSUMO_BAR
}

enum TipoCampeonato {
  MATA_MATA
  GRUPOS
}

enum DesempateTipo {
  PENALTIS
  WO
  MELHOR_CAMPANHA
  OUTRO
}

enum EventoTipo {
  GOL
  CARTAO_AMARELO
  CARTAO_VERMELHO
  CHUTE
  CHUTE_NO_GOL
  ESCANTEIO
  LATERAL
  FALTA
  SUBSTITUICAO
  OBSERVACAO
}

enum StatusAgendamento {
  PENDENTE
  CONFIRMADO
  CANCELADO
}

enum StatusPagamento {
  PENDENTE
  PAGO
  CANCELADO
}

enum FormaPagamento {
  PIX
  DINHEIRO
  CARTAO
  TRANSFERENCIA
  OUTRO
}

model Usuario {
  id           Int       @id @default(autoincrement())
  nome         String
  cpf          String?   @unique
  email        String    @unique
  senha        String
  telefone     String?
  pernaMelhor  String?
  posicaoCampo String?
  altura       Float?
  peso         Float?
  modalidade   String?
  nascimento   DateTime?
  goleiro      Boolean?
  sexo         String?

  tipo TipoUsuario @default(PLAYER)

  times Time[] @relation("TimeDono")

  // jogador pertence a um time (modelo atual seu)
  timeRelacionadoId Int?
  timeRelacionado   Time? @relation("TimeJogadores", fields: [timeRelacionadoId], references: [id])

  societies      Society[]       @relation("UsuarioSocieties")
  pagamentos     Pagamento[]
  notificacoes   Notificacao[]
  societyPlayers SocietyPlayer[]

  // antigo (mantido)
  estatisticas EstatisticaJogo[]

  // novo (detalhes do jogo)
  jogoEventos  JogoEvento[]
  jogosAtuacao JogoJogador[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Society {
  id        Int     @id @default(autoincrement())
  usuarioId Int
  dono      Usuario @relation("UsuarioSocieties", fields: [usuarioId], references: [id], onDelete: Cascade)

  imagem    String?
  nome      String
  descricao String?
  telefone  String?
  whatsapp  String?
  email     String?
  website   String?
  instagram String?
  facebook  String?
  youtube   String?

  cep      String?
  endereco String?
  estado   String?
  cidade   String?

  cardapio       Cardapio[]
  campos         Campo[]
  societyPlayers SocietyPlayer[]
  pagamentos     Pagamento[]
  campeonatos    Campeonato[]
  times          Time[]
  agendamentos   Agendamento[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Cardapio {
  id        Int     @id @default(autoincrement())
  societyId Int
  society   Society @relation(fields: [societyId], references: [id], onDelete: Cascade)

  nome  String
  preco Float

  createdAt DateTime @default(now())

  @@index([societyId])
}

model Campo {
  id Int @id @default(autoincrement())

  // ✅ AMARRADO AO SOCIETY (obrigatório)
  societyId Int
  society   Society @relation(fields: [societyId], references: [id], onDelete: Cascade)

  nome        String
  valorAvulso Float? // <- por hora (ex: 500)
  valorMensal Float?
  fotoUrl     String?
  dimensoes   String?
  gramado     String?

  createdAt    DateTime      @default(now())
  agendamentos Agendamento[]
  pagamentos   Pagamento[]

  @@unique([societyId, nome])
  @@index([societyId])
}

model Time {
  id         Int     @id @default(autoincrement())
  nome       String
  brasao     String?
  descricao  String?
  estado     String?
  cidade     String?
  modalidade String?

  societyId Int
  society   Society @relation(fields: [societyId], references: [id], onDelete: Cascade)

  donoId Int
  dono   Usuario @relation("TimeDono", fields: [donoId], references: [id], onDelete: Cascade)

  jogadores Usuario[] @relation("TimeJogadores")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  timeCampeonatos TimeCampeonato[]
  jogosMandante   Jogo[]           @relation("JogoTimeA")
  jogosVisitante  Jogo[]           @relation("JogoTimeB")

  campeonatosVencidos Campeonato[] @relation("CampeaoTime")
  campeonatosVice     Campeonato[] @relation("ViceCampeaoTime")

  timeGrupos TimeGrupo[]

  // novos
  tabelaCampeonatos TabelaCampeonato[]
  jogoStats         JogoEstatisticaTime[]
  jogoJogadores     JogoJogador[]
  jogoEventos       JogoEvento[]
  agendamentos      Agendamento[]
  pagamentos        Pagamento[]

  @@unique([societyId, nome])
  @@index([societyId])
  @@index([donoId])
}

model Pagamento {
  id Int @id @default(autoincrement())

  usuarioId Int
  usuario   Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  societyId Int
  society   Society @relation(fields: [societyId], references: [id], onDelete: Cascade)

  timeId Int?
  time   Time? @relation(fields: [timeId], references: [id], onDelete: SetNull)

  campoId Int?
  campo   Campo? @relation(fields: [campoId], references: [id], onDelete: SetNull)

  agendamentoId Int?         @unique
  agendamento   Agendamento? @relation(fields: [agendamentoId], references: [id], onDelete: Cascade)

  tipo      TipoPagamento
  valor     Float
  descricao String?

  status StatusPagamento @default(PENDENTE)
  forma  FormaPagamento  @default(PIX)

  pagoEm DateTime?

  createdAt DateTime @default(now())

  @@index([societyId])
  @@index([usuarioId])
  @@index([timeId])
  @@index([campoId])
}

model Agendamento {
  id Int @id @default(autoincrement())

  societyId Int
  society   Society @relation(fields: [societyId], references: [id], onDelete: Cascade)

  campoId Int
  campo   Campo @relation(fields: [campoId], references: [id], onDelete: Cascade)

  timeId Int
  time   Time @relation(fields: [timeId], references: [id], onDelete: Cascade)

  data       DateTime
  horaInicio String
  horaFim    String

  valor Float

  status StatusAgendamento @default(PENDENTE)

  // ✅ 1–1
  pagamento Pagamento?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([societyId, campoId, data])
  @@index([timeId, data])
}

model SocietyPlayer {
  id Int @id @default(autoincrement())

  societyId Int
  society   Society @relation(fields: [societyId], references: [id], onDelete: Cascade)

  usuarioId Int
  usuario   Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([societyId, usuarioId])
  @@index([societyId])
  @@index([usuarioId])
}

model Notificacao {
  id        Int     @id @default(autoincrement())
  usuarioId Int
  usuario   Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  titulo   String
  mensagem String
  lido     Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([usuarioId])
}

model Campeonato {
  id        Int     @id @default(autoincrement())
  societyId Int
  society   Society @relation(fields: [societyId], references: [id], onDelete: Cascade)

  nome     String
  tipo     TipoCampeonato
  maxTimes Int

  faseAtual  String @default("GRUPOS")
  roundAtual Int    @default(1)

  campeaoId Int?
  campeao   Time? @relation("CampeaoTime", fields: [campeaoId], references: [id], onDelete: SetNull)

  viceCampeaoId Int?
  viceCampeao   Time? @relation("ViceCampeaoTime", fields: [viceCampeaoId], references: [id], onDelete: SetNull)

  times  TimeCampeonato[]
  grupos Grupo[]
  jogos  Jogo[]

  tabela TabelaCampeonato[]

  createdAt DateTime @default(now())

  @@index([societyId])
}

model TimeCampeonato {
  id           Int        @id @default(autoincrement())
  campeonatoId Int
  campeonato   Campeonato @relation(fields: [campeonatoId], references: [id], onDelete: Cascade)

  timeId Int
  time   Time @relation(fields: [timeId], references: [id], onDelete: Cascade)

  @@unique([campeonatoId, timeId])
  @@index([campeonatoId])
  @@index([timeId])
}

model Grupo {
  id           Int        @id @default(autoincrement())
  nome         String
  campeonatoId Int
  campeonato   Campeonato @relation(fields: [campeonatoId], references: [id], onDelete: Cascade)

  timesGrupo TimeGrupo[]
  jogos      Jogo[]

  @@index([campeonatoId])
}

model TimeGrupo {
  id      Int   @id @default(autoincrement())
  grupoId Int
  grupo   Grupo @relation(fields: [grupoId], references: [id], onDelete: Cascade)

  timeId Int
  time   Time @relation(fields: [timeId], references: [id], onDelete: Cascade)

  pontos     Int @default(0)
  vitorias   Int @default(0)
  empates    Int @default(0)
  derrotas   Int @default(0)
  golsPro    Int @default(0)
  golsContra Int @default(0)
  saldoGols  Int @default(0)

  @@unique([grupoId, timeId])
  @@index([grupoId])
  @@index([timeId])
}

model Jogo {
  id           Int        @id @default(autoincrement())
  campeonatoId Int
  campeonato   Campeonato @relation(fields: [campeonatoId], references: [id], onDelete: Cascade)

  round   Int
  grupoId Int?
  grupo   Grupo? @relation(fields: [grupoId], references: [id], onDelete: SetNull)

  timeAId Int
  timeA   Time @relation("JogoTimeA", fields: [timeAId], references: [id], onDelete: Cascade)

  timeBId Int
  timeB   Time @relation("JogoTimeB", fields: [timeBId], references: [id], onDelete: Cascade)

  golsA Int?
  golsB Int?

  vencedorId Int?

  desempateTipo DesempateTipo?
  penaltisA     Int?
  penaltisB     Int?

  observacao String?
  dataHora   DateTime?

  finalizado Boolean @default(false)

  estatisticas EstatisticaJogo[]

  estatisticasTimes JogoEstatisticaTime[]
  eventos           JogoEvento[]
  jogadoresAtuacao  JogoJogador[]

  @@index([campeonatoId])
  @@index([grupoId])
  @@index([timeAId])
  @@index([timeBId])
}

model EstatisticaJogo {
  id     Int  @id @default(autoincrement())
  jogoId Int
  jogo   Jogo @relation(fields: [jogoId], references: [id], onDelete: Cascade)

  jogadorId Int
  jogador   Usuario @relation(fields: [jogadorId], references: [id], onDelete: Cascade)

  gols      Int @default(0)
  amarelos  Int @default(0)
  vermelhos Int @default(0)

  @@index([jogoId])
  @@index([jogadorId])
}

model TabelaCampeonato {
  id Int @id @default(autoincrement())

  campeonatoId Int
  campeonato   Campeonato @relation(fields: [campeonatoId], references: [id], onDelete: Cascade)

  timeId Int
  time   Time @relation(fields: [timeId], references: [id], onDelete: Cascade)

  pontos     Int @default(0)
  vitorias   Int @default(0)
  empates    Int @default(0)
  derrotas   Int @default(0)
  golsPro    Int @default(0)
  golsContra Int @default(0)
  saldoGols  Int @default(0)

  updatedAt DateTime @updatedAt

  @@unique([campeonatoId, timeId])
  @@index([campeonatoId])
  @@index([timeId])
}

model JogoEstatisticaTime {
  id Int @id @default(autoincrement())

  jogoId Int
  jogo   Jogo @relation(fields: [jogoId], references: [id], onDelete: Cascade)

  timeId Int
  time   Time @relation(fields: [timeId], references: [id], onDelete: Cascade)

  chutes      Int @default(0)
  chutesNoGol Int @default(0)
  escanteios  Int @default(0)
  laterais    Int @default(0)
  faltas      Int @default(0)
  posse       Int @default(0)

  updatedAt DateTime @updatedAt

  @@unique([jogoId, timeId])
  @@index([jogoId])
  @@index([timeId])
}

model JogoJogador {
  id Int @id @default(autoincrement())

  jogoId Int
  jogo   Jogo @relation(fields: [jogoId], references: [id], onDelete: Cascade)

  timeId Int
  time   Time @relation(fields: [timeId], references: [id], onDelete: Cascade)

  jogadorId Int
  jogador   Usuario @relation(fields: [jogadorId], references: [id], onDelete: Cascade)

  titular      Boolean @default(false)
  entrouMinuto Int?
  saiuMinuto   Int?

  @@unique([jogoId, jogadorId])
  @@index([jogoId])
  @@index([timeId])
  @@index([jogadorId])
}

model JogoEvento {
  id Int @id @default(autoincrement())

  jogoId Int
  jogo   Jogo @relation(fields: [jogoId], references: [id], onDelete: Cascade)

  tipo   EventoTipo
  minuto Int?

  timeId Int?
  time   Time? @relation(fields: [timeId], references: [id], onDelete: SetNull)

  jogadorId Int?
  jogador   Usuario? @relation(fields: [jogadorId], references: [id], onDelete: SetNull)

  jogadorSaindoId   Int?
  jogadorEntrandoId Int?

  detalhe String?

  createdAt DateTime @default(now())

  @@index([jogoId])
  @@index([timeId])
  @@index([jogadorId])
}
